<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using Other Simulation Programs with CKMRpop • CKMRpop</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using Other Simulation Programs with CKMRpop">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CKMRpop</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.3.9999</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/about_spip.html">About spip</a>
    </li>
    <li>
      <a href="../articles/population-growth-with-spip.html">population-growth-with-spip</a>
    </li>
    <li>
      <a href="../articles/simple-example-with-migration.html">A Simple Example With Migration</a>
    </li>
    <li>
      <a href="../articles/species_1_simulation.html">Simulation from species 1 life history</a>
    </li>
    <li>
      <a href="../articles/using-other-simulation-programs.html">Using Other Simulation Programs with CKMRpop</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using Other Simulation Programs with
CKMRpop</h1>
                        <h4 data-toc-skip class="author">Eric C.
Anderson</h4>
            
            <h4 data-toc-skip class="date">2025-04-07</h4>
      

      <div class="hidden name"><code>using-other-simulation-programs.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>CKMRpop was developed to crunch and slurp the output of the
simulation package <code>spip</code>; however other programs can be
configured to produce the output needed for CKMRpop to create the
summaries that it does.</p>
<p>Currently, the files of massaged spip output that CKMRpop uses look
like the following (each file’s name is listed between
<code>==&gt; XXX &lt;==</code> markers, and then the first 10 lines of
the file are shown).</p>
<pre><code>% head spip*.tsv
==&gt; spip_deaths.tsv &lt;==
ID  year    age
M3_0_0  5   2
M3_0_4  5   2
M3_0_5  5   2
M3_0_10 5   2
M3_0_13 5   2
M3_0_16 5   2
M3_0_18 5   2
M3_0_20 5   2
M3_0_21 5   2

==&gt; spip_genotypes.tsv &lt;==
F5_0_100    2/2
M5_0_84 1/1
M7_0_1  1/1
M7_0_92 1/1
F8_0_85 1/2
F8_0_95 2/2
M8_0_51 1/1
M8_0_56 2/2
M8_0_91 2/1
F9_0_17 1/1

==&gt; spip_migrants.tsv &lt;==
year    age event
5   1   M4_0_6 0 -&gt; 2
5   1   M4_0_11 0 -&gt; 1
5   1   M4_0_12 0 -&gt; 1
5   1   M4_0_19 0 -&gt; 1
5   1   M4_0_20 0 -&gt; 1
5   1   M4_0_28 0 -&gt; 1
5   1   M4_0_29 0 -&gt; 1
5   1   M4_0_43 0 -&gt; 1
5   1   M4_0_44 0 -&gt; 1

==&gt; spip_pedigree.tsv &lt;==
year    pop kid pa  ma
0   0   M0_0_0  0   0
0   0   M0_0_1  0   0
0   0   M0_0_2  0   0
0   0   M0_0_3  0   0
0   0   M0_0_4  0   0
0   0   M0_0_5  0   0
0   0   M0_0_6  0   0
0   0   M0_0_7  0   0
0   0   M0_0_8  0   0

==&gt; spip_postkill_census.tsv &lt;==
year    pop age male    female
5   0   1   99  101
5   0   2   78  90
5   0   3   66  73
5   0   4   52  55
5   0   5   49  50
5   1   1   142 136
5   1   2   94  87
5   1   3   70  70
5   1   4   54  57

==&gt; spip_prekill_census.tsv &lt;==
year    pop age male    female
5   0   1   99  101
5   0   2   125 125
5   0   3   87  87
5   0   4   70  70
5   0   5   56  56
5   1   1   142 136
5   1   2   125 125
5   1   3   87  87
5   1   4   70  70

==&gt; spip_samples.tsv &lt;==
ID  syears_pre  pop_pre syears_post pop_post    syears_dur  pop_dur
F5_0_100            10  0
M5_0_84         10  0
M7_0_1          12  0
M7_0_92         11  0
F8_0_85         11  0
F8_0_95         10  0
M8_0_51         10  0
M8_0_56         13  0
M8_0_91         10  0</code></pre>
<p>The structure of the files is largely self-explanatory, but here are
a few pertinent notes:</p>
<ol style="list-style-type: decimal">
<li><p>The IDs of the individuals are of the form:
<code>Sex + BornYear + "_" + Subpop_Index + "_" + AnInteger</code>. So,
for example, <code>F8_0_85</code> is a female (with ID 85) born in year
8. Some functions within CKMRpop parse these IDs to retrieve the sex and
birth year of the individual.</p></li>
<li><p>The files are TAB-delimited.</p></li>
<li><p>Migration events are recorded as space-delimited phrases like:
<code>M4_0_6 0 -&gt; 2</code>, which says that <code>M4_0_6</code>
migrated from subpopulation <code>0</code> to subpopulation
<code>2</code>.</p></li>
<li><p>The pedigree must be the complete pedigree of the
population.</p></li>
</ol>
<p>In order to use a different simulation program, one approach is to
simply write out output files like the above from the simulation output
of your simulation engine of choice. Another possibility is to use the
internal pedigree recording mechanism (if it exists) of your preferred
simulation program.</p>
<p>I illustrate these two different approaches in the following two
section using the outstanding, full-featured, and well-supported
population genetic simulation software, SLiM Version 3 <span class="citation">(Haller and Messer 2019)</span>.</p>
</div>
<div class="section level2">
<h2 id="writing-slim-output-to-files">Writing SLiM output to files<a class="anchor" aria-label="anchor" href="#writing-slim-output-to-files"></a>
</h2>
<p>Before doing anything else here, let us load some useful
libraries:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">CKMRpop</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span></span>
<span><span class="co"># also define a variable that says whether or not we should evaluate</span></span>
<span><span class="co"># code chunks that depend on having SLiM installed on the system.  </span></span>
<span><span class="va">eval_slim_dep</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span> <span class="co"># file.exists("/usr/local/bin/slim")  # SLIM 4 has broken this a little.  Must fix</span></span></code></pre></div>
<p>By way of example, here I devise a simulation in SLiM, Version 3.6,
that approximates the <code>species_1_simulation</code> in the other
vignette. It approximates it in the sense that the maximum age and the
survival probabilities are similar between the two simulations; however
I did not spend a lot of time tweaking the SLiM script to have
overdispersion in family sizes, or a mating pattern that looks like what
is coded up in <code>spip</code> in the other vignette.</p>
<p>This SLiM script can be found in the package extras at:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"SLiM/slim-example-1.slim"</span>, package <span class="op">=</span> <span class="st">"CKMRpop"</span><span class="op">)</span></span></code></pre></div>
<p>It looks like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>initialize<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    initializeSLiMModelType<span class="op">(</span><span class="st">"nonWF"</span><span class="op">);</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    defineConstant<span class="op">(</span><span class="st">"K"</span><span class="op">,</span> <span class="dv">1290</span><span class="op">);</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    <span class="co">// "species 1" mortality rates for ages 0 to 20.  (All 20-year-olds die) </span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    defineConstant<span class="op">(</span><span class="st">"L"</span><span class="op">,</span> c<span class="op">(</span><span class="fl">0.25</span><span class="op">,</span> <span class="fl">0.24</span><span class="op">,</span> <span class="fl">0.24</span><span class="op">,</span> <span class="fl">0.23</span><span class="op">,</span> <span class="fl">0.23</span><span class="op">,</span> <span class="fl">0.22</span><span class="op">,</span> <span class="fl">0.22</span><span class="op">,</span> <span class="fl">0.21</span><span class="op">,</span> <span class="fl">0.21</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.19</span><span class="op">,</span> <span class="fl">0.19</span><span class="op">,</span> <span class="fl">0.18</span><span class="op">,</span> <span class="fl">0.18</span><span class="op">,</span> <span class="fl">0.18</span><span class="op">,</span> <span class="fl">0.18</span><span class="op">,</span> <span class="fl">0.18</span><span class="op">,</span> <span class="fl">0.18</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">));</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    </span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    initializeMutationType<span class="op">(</span><span class="st">"m1"</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">,</span> <span class="st">"f"</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>    m1<span class="op">.</span>convertToSubstitution <span class="op">=</span> T<span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>    initializeGenomicElementType<span class="op">(</span><span class="st">"g1"</span><span class="op">,</span> m1<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>    initializeGenomicElement<span class="op">(</span>g1<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>    initializeMutationRate<span class="op">(</span><span class="fl">1e-20</span><span class="op">);</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>    initializeRecombinationRate<span class="op">(</span><span class="fl">1e-20</span><span class="op">);</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>    initializeSex<span class="op">(</span><span class="st">"A"</span><span class="op">);</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>    </span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>    </span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>    <span class="co">// delete any files that will be appended to and write the headers on them that CKMRpop expects</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"spip_pedigree.tsv"</span><span class="op">,</span> <span class="st">"year</span><span class="sc">\t</span><span class="st">pop</span><span class="sc">\t</span><span class="st">kid</span><span class="sc">\t</span><span class="st">pa</span><span class="sc">\t</span><span class="st">ma"</span><span class="op">);</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"spip_prekill_census.tsv"</span><span class="op">,</span> <span class="st">"year</span><span class="sc">\t</span><span class="st">pop</span><span class="sc">\t</span><span class="st">age</span><span class="sc">\t</span><span class="st">male</span><span class="sc">\t</span><span class="st">female"</span><span class="op">);</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"spip_postkill_census.tsv"</span><span class="op">,</span> <span class="st">"year</span><span class="sc">\t</span><span class="st">pop</span><span class="sc">\t</span><span class="st">age</span><span class="sc">\t</span><span class="st">male</span><span class="sc">\t</span><span class="st">female"</span><span class="op">);</span></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"spip_samples.tsv"</span><span class="op">,</span> <span class="st">"ID</span><span class="sc">\t</span><span class="st">syears_pre</span><span class="sc">\t</span><span class="st">pop_pre</span><span class="sc">\t</span><span class="st">syears_post</span><span class="sc">\t</span><span class="st">pop_post</span><span class="sc">\t</span><span class="st">syears_dur</span><span class="sc">\t</span><span class="st">pop_dur"</span><span class="op">);</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>    </span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>    <span class="co">// these I am just making empty as dummies so that slurp_spip() has an empty</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>    <span class="co">// file to read in. </span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"spip_deaths.tsv"</span><span class="op">,</span> <span class="st">"ID</span><span class="sc">\t</span><span class="st">year</span><span class="sc">\t</span><span class="st">age"</span><span class="op">);</span></span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"spip_genotypes.tsv"</span><span class="op">,</span> <span class="st">"F47_0_136</span><span class="sc">\t</span><span class="st">2/2"</span><span class="op">);</span></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"spip_migrants.tsv"</span><span class="op">,</span> <span class="st">"year</span><span class="sc">\t</span><span class="st">age</span><span class="sc">\t</span><span class="st">event"</span><span class="op">);</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a><span class="co">// we don't bother with any age-specific relative fecundities or partial</span></span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a><span class="co">// monogamy in the reproduction here. Rather, we just give males and females</span></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a><span class="co">// a probability of 1.0 of reproducing if they are above age 6.  It appears that</span></span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a><span class="co">// we just do Poisson number of offspring or something, by default here.  I am</span></span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a><span class="co">// not going to fuss with overdispersion, though that is clearly possible with SLiM.</span></span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a>reproduction<span class="op">(</span>NULL<span class="op">,</span> <span class="st">"F"</span><span class="op">)</span> <span class="op">{</span>   <span class="co">// define females as the focal reproducers here</span></span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a>    </span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>individual<span class="op">.</span>age <span class="op">&gt;</span> <span class="dv">6</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a>        dad <span class="op">=</span> subpop<span class="op">.</span>sampleIndividuals<span class="op">(</span><span class="dv">1</span><span class="op">,</span> sex<span class="op">=</span><span class="st">"M"</span><span class="op">,</span> minAge<span class="op">=</span><span class="dv">7</span><span class="op">);</span></span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a>        child <span class="op">=</span> subpop<span class="op">.</span>addCrossed<span class="op">(</span>individual<span class="op">,</span> dad<span class="op">);</span></span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a>        </span>
<span id="cb4-42"><a href="#cb4-42" tabindex="-1"></a>        <span class="co">// give the child an index according to the number of like-sex individuals</span></span>
<span id="cb4-43"><a href="#cb4-43" tabindex="-1"></a>        <span class="co">// that have been created this year (base-0 subscripted)</span></span>
<span id="cb4-44"><a href="#cb4-44" tabindex="-1"></a>        child<span class="op">.</span>tag <span class="op">=</span> sim<span class="op">.</span>tag<span class="op">;</span></span>
<span id="cb4-45"><a href="#cb4-45" tabindex="-1"></a>        </span>
<span id="cb4-46"><a href="#cb4-46" tabindex="-1"></a>        sim<span class="op">.</span>tag <span class="op">=</span> sim<span class="op">.</span>tag <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-47"><a href="#cb4-47" tabindex="-1"></a>        </span>
<span id="cb4-48"><a href="#cb4-48" tabindex="-1"></a>        <span class="co">// log the mating in a format that CKMRpop expects.  It isn't entirely equivalent</span></span>
<span id="cb4-49"><a href="#cb4-49" tabindex="-1"></a>        <span class="co">// because the numbers given to males and females in spip are year-specific, but this</span></span>
<span id="cb4-50"><a href="#cb4-50" tabindex="-1"></a>        <span class="co">// should still work.</span></span>
<span id="cb4-51"><a href="#cb4-51" tabindex="-1"></a>        child_name <span class="op">=</span> paste0<span class="op">(</span>child<span class="op">.</span>sex<span class="op">,</span> sim<span class="op">.</span>generation<span class="op">,</span> <span class="st">"_0_"</span><span class="op">,</span> child<span class="op">.</span>tag<span class="op">);</span></span>
<span id="cb4-52"><a href="#cb4-52" tabindex="-1"></a>        dad_name <span class="op">=</span> paste0<span class="op">(</span>dad<span class="op">.</span>sex<span class="op">,</span> sim<span class="op">.</span>generation <span class="op">-</span> dad<span class="op">.</span>age<span class="op">,</span> <span class="st">"_0_"</span><span class="op">,</span> dad<span class="op">.</span>tag<span class="op">);</span></span>
<span id="cb4-53"><a href="#cb4-53" tabindex="-1"></a>        mom_name <span class="op">=</span> paste0<span class="op">(</span>individual<span class="op">.</span>sex<span class="op">,</span> sim<span class="op">.</span>generation <span class="op">-</span> individual<span class="op">.</span>age<span class="op">,</span> <span class="st">"_0_"</span><span class="op">,</span> individual<span class="op">.</span>tag<span class="op">);</span></span>
<span id="cb4-54"><a href="#cb4-54" tabindex="-1"></a>        line <span class="op">=</span> paste<span class="op">(</span>c<span class="op">(</span>sim<span class="op">.</span>generation<span class="op">,</span> <span class="st">"0"</span><span class="op">,</span> child_name<span class="op">,</span> dad_name<span class="op">,</span> mom_name<span class="op">),</span> sep <span class="op">=</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb4-55"><a href="#cb4-55" tabindex="-1"></a>        writeFile<span class="op">(</span><span class="st">"spip_pedigree.tsv"</span><span class="op">,</span> line<span class="op">,</span> append<span class="op">=</span>T<span class="op">);</span></span>
<span id="cb4-56"><a href="#cb4-56" tabindex="-1"></a>    </span>
<span id="cb4-57"><a href="#cb4-57" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-58"><a href="#cb4-58" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-59"><a href="#cb4-59" tabindex="-1"></a></span>
<span id="cb4-60"><a href="#cb4-60" tabindex="-1"></a></span>
<span id="cb4-61"><a href="#cb4-61" tabindex="-1"></a><span class="dv">1</span> early<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-62"><a href="#cb4-62" tabindex="-1"></a>    sim<span class="op">.</span>addSubpop<span class="op">(</span><span class="st">"p1"</span><span class="op">,</span> K<span class="op">);</span></span>
<span id="cb4-63"><a href="#cb4-63" tabindex="-1"></a>    <span class="co">// Here we initialize the ages to what would be the stationary age distribution</span></span>
<span id="cb4-64"><a href="#cb4-64" tabindex="-1"></a>    <span class="co">// (roughly) given the survival rates.</span></span>
<span id="cb4-65"><a href="#cb4-65" tabindex="-1"></a>    p1<span class="op">.</span>individuals<span class="op">.</span>age <span class="op">=</span> sample<span class="op">(</span>seq<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">20</span><span class="op">),</span> size <span class="op">=</span> K<span class="op">,</span> replace <span class="op">=</span> T<span class="op">,</span> weights <span class="op">=</span> c<span class="op">(</span><span class="dv">150</span><span class="op">,</span> <span class="dv">112</span><span class="op">,</span> <span class="dv">85</span><span class="op">,</span> <span class="dv">64</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">38</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">23</span><span class="op">,</span> <span class="dv">18</span><span class="op">,</span> <span class="dv">14</span><span class="op">,</span> <span class="dv">11</span><span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb4-66"><a href="#cb4-66" tabindex="-1"></a>    </span>
<span id="cb4-67"><a href="#cb4-67" tabindex="-1"></a>    </span>
<span id="cb4-68"><a href="#cb4-68" tabindex="-1"></a>    </span>
<span id="cb4-69"><a href="#cb4-69" tabindex="-1"></a>    <span class="co">// provide initial tags and remember the next tag value</span></span>
<span id="cb4-70"><a href="#cb4-70" tabindex="-1"></a>    p1<span class="op">.</span>individuals<span class="op">.</span>tag <span class="op">=</span> <span class="dv">1</span><span class="op">:</span>K<span class="op">;</span></span>
<span id="cb4-71"><a href="#cb4-71" tabindex="-1"></a>    sim<span class="op">.</span>tag <span class="op">=</span> K <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-72"><a href="#cb4-72" tabindex="-1"></a>    </span>
<span id="cb4-73"><a href="#cb4-73" tabindex="-1"></a>    <span class="co">// Now we also have to add each of these starting individuals to</span></span>
<span id="cb4-74"><a href="#cb4-74" tabindex="-1"></a>    <span class="co">// the pedigree as founders.</span></span>
<span id="cb4-75"><a href="#cb4-75" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>i in seqAlong<span class="op">(</span>p1<span class="op">.</span>individuals<span class="op">.</span>tag<span class="op">))</span> <span class="op">{</span></span>
<span id="cb4-76"><a href="#cb4-76" tabindex="-1"></a>        bornyear <span class="op">=</span> sim<span class="op">.</span>generation <span class="op">-</span> p1<span class="op">.</span>individuals<span class="op">.</span>age<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb4-77"><a href="#cb4-77" tabindex="-1"></a>        iname <span class="op">=</span> p1<span class="op">.</span>individuals<span class="op">.</span>sex<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> bornyear <span class="op">+</span> <span class="st">"_0_"</span> <span class="op">+</span> p1<span class="op">.</span>individuals<span class="op">.</span>tag<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb4-78"><a href="#cb4-78" tabindex="-1"></a>        iage <span class="op">=</span> p1<span class="op">.</span>individuals<span class="op">.</span>age<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb4-79"><a href="#cb4-79" tabindex="-1"></a>        line <span class="op">=</span> paste<span class="op">(</span><span class="st">"0"</span><span class="op">,</span> <span class="st">"0"</span><span class="op">,</span> iname<span class="op">,</span> <span class="st">"0"</span><span class="op">,</span> <span class="st">"0"</span><span class="op">,</span> sep <span class="op">=</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">);</span>  </span>
<span id="cb4-80"><a href="#cb4-80" tabindex="-1"></a>        writeFile<span class="op">(</span><span class="st">"spip_pedigree.tsv"</span><span class="op">,</span> line<span class="op">,</span> append<span class="op">=</span>T<span class="op">);</span></span>
<span id="cb4-81"><a href="#cb4-81" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-82"><a href="#cb4-82" tabindex="-1"></a></span>
<span id="cb4-83"><a href="#cb4-83" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-84"><a href="#cb4-84" tabindex="-1"></a></span>
<span id="cb4-85"><a href="#cb4-85" tabindex="-1"></a></span>
<span id="cb4-86"><a href="#cb4-86" tabindex="-1"></a>early<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-87"><a href="#cb4-87" tabindex="-1"></a>    <span class="co">// count up the number of individuals of different ages and sexes</span></span>
<span id="cb4-88"><a href="#cb4-88" tabindex="-1"></a>    inds <span class="op">=</span> p1<span class="op">.</span>individuals<span class="op">;</span></span>
<span id="cb4-89"><a href="#cb4-89" tabindex="-1"></a>    ages <span class="op">=</span> inds<span class="op">.</span>age<span class="op">;</span></span>
<span id="cb4-90"><a href="#cb4-90" tabindex="-1"></a>    age_bins <span class="op">=</span> <span class="dv">0</span><span class="op">:</span><span class="dv">20</span><span class="op">;</span>  <span class="co">// age categories, 0 to 20</span></span>
<span id="cb4-91"><a href="#cb4-91" tabindex="-1"></a>    male_ages <span class="op">=</span> ages<span class="op">[</span>inds<span class="op">.</span>sex <span class="op">==</span> <span class="st">"M"</span><span class="op">];</span></span>
<span id="cb4-92"><a href="#cb4-92" tabindex="-1"></a>    female_ages <span class="op">=</span> ages<span class="op">[</span>inds<span class="op">.</span>sex <span class="op">==</span> <span class="st">"F"</span><span class="op">];</span></span>
<span id="cb4-93"><a href="#cb4-93" tabindex="-1"></a>    <span class="va">m_census</span> <span class="op">=</span> tabulate<span class="op">(</span>male_ages<span class="op">,</span> maxbin <span class="op">=</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb4-94"><a href="#cb4-94" tabindex="-1"></a>    f_census <span class="op">=</span> tabulate<span class="op">(</span>female_ages<span class="op">,</span> maxbin <span class="op">=</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb4-95"><a href="#cb4-95" tabindex="-1"></a>    </span>
<span id="cb4-96"><a href="#cb4-96" tabindex="-1"></a>    <span class="co">// write those numbers out to the prekill census file</span></span>
<span id="cb4-97"><a href="#cb4-97" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>a in age_bins<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-98"><a href="#cb4-98" tabindex="-1"></a>        line <span class="op">=</span> paste<span class="op">(</span>sim<span class="op">.</span>generation<span class="op">,</span> <span class="st">"0"</span><span class="op">,</span> a<span class="op">,</span> <span class="va">m_census</span><span class="op">[</span>a<span class="op">],</span> f_census<span class="op">[</span>a<span class="op">],</span> sep <span class="op">=</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb4-99"><a href="#cb4-99" tabindex="-1"></a>        writeFile<span class="op">(</span><span class="st">"spip_prekill_census.tsv"</span><span class="op">,</span> line<span class="op">,</span> append<span class="op">=</span>T<span class="op">);</span></span>
<span id="cb4-100"><a href="#cb4-100" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-101"><a href="#cb4-101" tabindex="-1"></a>    </span>
<span id="cb4-102"><a href="#cb4-102" tabindex="-1"></a>    </span>
<span id="cb4-103"><a href="#cb4-103" tabindex="-1"></a>    </span>
<span id="cb4-104"><a href="#cb4-104" tabindex="-1"></a>    <span class="co">// life table based individual mortality</span></span>
<span id="cb4-105"><a href="#cb4-105" tabindex="-1"></a>    mortality <span class="op">=</span> L<span class="op">[</span>ages<span class="op">];</span></span>
<span id="cb4-106"><a href="#cb4-106" tabindex="-1"></a>    survival <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> mortality<span class="op">;</span></span>
<span id="cb4-107"><a href="#cb4-107" tabindex="-1"></a>    inds<span class="op">.</span>fitnessScaling <span class="op">=</span> survival<span class="op">;</span></span>
<span id="cb4-108"><a href="#cb4-108" tabindex="-1"></a>    <span class="co">// density-dependence, factoring in individual mortality</span></span>
<span id="cb4-109"><a href="#cb4-109" tabindex="-1"></a>    p1<span class="op">.</span>fitnessScaling <span class="op">=</span> K <span class="op">/</span> <span class="op">(</span>p1<span class="op">.</span>individualCount <span class="op">*</span> mean<span class="op">(</span>survival<span class="op">));</span></span>
<span id="cb4-110"><a href="#cb4-110" tabindex="-1"></a>    </span>
<span id="cb4-111"><a href="#cb4-111" tabindex="-1"></a>    <span class="co">// remember the extant individual tags, and what their names are.</span></span>
<span id="cb4-112"><a href="#cb4-112" tabindex="-1"></a>    <span class="co">// This is a bunch of rigamoral so that we can know the IDs of the</span></span>
<span id="cb4-113"><a href="#cb4-113" tabindex="-1"></a>    <span class="co">// individuals that die in the next generation</span></span>
<span id="cb4-114"><a href="#cb4-114" tabindex="-1"></a>    sim<span class="op">.</span>setValue<span class="op">(</span><span class="st">"extant_tags"</span><span class="op">,</span> sim<span class="op">.</span>subpopulations<span class="op">.</span>individuals<span class="op">.</span>tag<span class="op">);</span></span>
<span id="cb4-115"><a href="#cb4-115" tabindex="-1"></a>    e_sex <span class="op">=</span> sim<span class="op">.</span>subpopulations<span class="op">.</span>individuals<span class="op">.</span>sex<span class="op">;</span></span>
<span id="cb4-116"><a href="#cb4-116" tabindex="-1"></a>    e_born <span class="op">=</span> sim<span class="op">.</span>generation <span class="op">-</span> sim<span class="op">.</span>subpopulations<span class="op">.</span>individuals<span class="op">.</span>age<span class="op">;</span></span>
<span id="cb4-117"><a href="#cb4-117" tabindex="-1"></a>    e_age <span class="op">=</span> sim<span class="op">.</span>subpopulations<span class="op">.</span>individuals<span class="op">.</span>age<span class="op">;</span></span>
<span id="cb4-118"><a href="#cb4-118" tabindex="-1"></a>    e_tags <span class="op">=</span> sim<span class="op">.</span>subpopulations<span class="op">.</span>individuals<span class="op">.</span>tag<span class="op">;</span></span>
<span id="cb4-119"><a href="#cb4-119" tabindex="-1"></a>    e_lines <span class="op">=</span> e_sex<span class="op">;</span></span>
<span id="cb4-120"><a href="#cb4-120" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>i in seqAlong<span class="op">(</span>e_sex<span class="op">))</span> <span class="op">{</span></span>
<span id="cb4-121"><a href="#cb4-121" tabindex="-1"></a>        e_lines<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> e_sex<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> e_born<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span>  <span class="st">"_0_"</span> <span class="op">+</span> e_tags<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span> <span class="op">+</span> sim<span class="op">.</span>generation <span class="op">+</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span> <span class="op">+</span> e_age<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb4-122"><a href="#cb4-122" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-123"><a href="#cb4-123" tabindex="-1"></a>    sim<span class="op">.</span>setValue<span class="op">(</span><span class="st">"extant_lines"</span><span class="op">,</span> e_lines<span class="op">);</span></span>
<span id="cb4-124"><a href="#cb4-124" tabindex="-1"></a></span>
<span id="cb4-125"><a href="#cb4-125" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-126"><a href="#cb4-126" tabindex="-1"></a></span>
<span id="cb4-127"><a href="#cb4-127" tabindex="-1"></a></span>
<span id="cb4-128"><a href="#cb4-128" tabindex="-1"></a>late<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-129"><a href="#cb4-129" tabindex="-1"></a>    <span class="co">// count up the number of individuals of different ages and sexes</span></span>
<span id="cb4-130"><a href="#cb4-130" tabindex="-1"></a>    inds <span class="op">=</span> p1<span class="op">.</span>individuals<span class="op">;</span></span>
<span id="cb4-131"><a href="#cb4-131" tabindex="-1"></a>    ages <span class="op">=</span> inds<span class="op">.</span>age<span class="op">;</span></span>
<span id="cb4-132"><a href="#cb4-132" tabindex="-1"></a>    age_bins <span class="op">=</span> <span class="dv">0</span><span class="op">:</span><span class="dv">20</span><span class="op">;</span>  <span class="co">// age categories, 0 to 20</span></span>
<span id="cb4-133"><a href="#cb4-133" tabindex="-1"></a>    male_ages <span class="op">=</span> ages<span class="op">[</span>inds<span class="op">.</span>sex <span class="op">==</span> <span class="st">"M"</span><span class="op">];</span></span>
<span id="cb4-134"><a href="#cb4-134" tabindex="-1"></a>    female_ages <span class="op">=</span> ages<span class="op">[</span>inds<span class="op">.</span>sex <span class="op">==</span> <span class="st">"F"</span><span class="op">];</span></span>
<span id="cb4-135"><a href="#cb4-135" tabindex="-1"></a>    <span class="va">m_census</span> <span class="op">=</span> tabulate<span class="op">(</span>male_ages<span class="op">,</span> maxbin <span class="op">=</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb4-136"><a href="#cb4-136" tabindex="-1"></a>    f_census <span class="op">=</span> tabulate<span class="op">(</span>female_ages<span class="op">,</span> maxbin <span class="op">=</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb4-137"><a href="#cb4-137" tabindex="-1"></a>    </span>
<span id="cb4-138"><a href="#cb4-138" tabindex="-1"></a>    <span class="co">// write those numbers out to the prekill census file</span></span>
<span id="cb4-139"><a href="#cb4-139" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>a in age_bins<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-140"><a href="#cb4-140" tabindex="-1"></a>        line <span class="op">=</span> paste<span class="op">(</span>sim<span class="op">.</span>generation<span class="op">,</span> <span class="st">"0"</span><span class="op">,</span> a<span class="op">,</span> <span class="va">m_census</span><span class="op">[</span>a<span class="op">],</span> f_census<span class="op">[</span>a<span class="op">],</span> sep <span class="op">=</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb4-141"><a href="#cb4-141" tabindex="-1"></a>        writeFile<span class="op">(</span><span class="st">"spip_postkill_census.tsv"</span><span class="op">,</span> line<span class="op">,</span> append<span class="op">=</span>T<span class="op">);</span></span>
<span id="cb4-142"><a href="#cb4-142" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-143"><a href="#cb4-143" tabindex="-1"></a>    </span>
<span id="cb4-144"><a href="#cb4-144" tabindex="-1"></a>    <span class="co">// report the individuals that died</span></span>
<span id="cb4-145"><a href="#cb4-145" tabindex="-1"></a>    oldExtant <span class="op">=</span> sim<span class="op">.</span>getValue<span class="op">(</span><span class="st">"extant_tags"</span><span class="op">);</span></span>
<span id="cb4-146"><a href="#cb4-146" tabindex="-1"></a>    newExtant <span class="op">=</span> sim<span class="op">.</span>subpopulations<span class="op">.</span>individuals<span class="op">.</span>tag<span class="op">;</span></span>
<span id="cb4-147"><a href="#cb4-147" tabindex="-1"></a>    old_lines <span class="op">=</span> sim<span class="op">.</span>getValue<span class="op">(</span><span class="st">"extant_lines"</span><span class="op">);</span></span>
<span id="cb4-148"><a href="#cb4-148" tabindex="-1"></a>    survived <span class="op">=</span> <span class="op">(</span>match<span class="op">(</span>oldExtant<span class="op">,</span> newExtant<span class="op">)</span> <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb4-149"><a href="#cb4-149" tabindex="-1"></a>    died_lines <span class="op">=</span> old_lines<span class="op">[!</span>survived<span class="op">];</span></span>
<span id="cb4-150"><a href="#cb4-150" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>line in died_lines<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-151"><a href="#cb4-151" tabindex="-1"></a>        writeFile<span class="op">(</span><span class="st">"spip_deaths.tsv"</span><span class="op">,</span> line<span class="op">,</span> append<span class="op">=</span>T<span class="op">);</span></span>
<span id="cb4-152"><a href="#cb4-152" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-153"><a href="#cb4-153" tabindex="-1"></a></span>
<span id="cb4-154"><a href="#cb4-154" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-155"><a href="#cb4-155" tabindex="-1"></a></span>
<span id="cb4-156"><a href="#cb4-156" tabindex="-1"></a></span>
<span id="cb4-157"><a href="#cb4-157" tabindex="-1"></a><span class="co">// sample 3% of the 1, 2, and 3-year olds during years 50 to 75, inclusive</span></span>
<span id="cb4-158"><a href="#cb4-158" tabindex="-1"></a><span class="dv">50</span><span class="op">:</span><span class="dv">75</span> late<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-159"><a href="#cb4-159" tabindex="-1"></a>    <span class="co">// get the total number of indivdiuals of age 1 to 3</span></span>
<span id="cb4-160"><a href="#cb4-160" tabindex="-1"></a>    num_1_to_3 <span class="op">=</span> sum<span class="op">(</span>tabulate<span class="op">(</span>p1<span class="op">.</span>individuals<span class="op">.</span>age<span class="op">,</span> maxbin <span class="op">=</span> <span class="dv">20</span><span class="op">)[</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span><span class="op">]);</span></span>
<span id="cb4-161"><a href="#cb4-161" tabindex="-1"></a>    </span>
<span id="cb4-162"><a href="#cb4-162" tabindex="-1"></a>    <span class="co">// get the total number to sample</span></span>
<span id="cb4-163"><a href="#cb4-163" tabindex="-1"></a>    ns <span class="op">=</span> rbinom<span class="op">(</span><span class="dv">1</span><span class="op">,</span> num_1_to_3<span class="op">,</span> <span class="fl">0.03</span><span class="op">);</span></span>
<span id="cb4-164"><a href="#cb4-164" tabindex="-1"></a>    </span>
<span id="cb4-165"><a href="#cb4-165" tabindex="-1"></a>    <span class="co">// then sample them:</span></span>
<span id="cb4-166"><a href="#cb4-166" tabindex="-1"></a>    samps <span class="op">=</span> p1<span class="op">.</span>sampleIndividuals<span class="op">(</span>ns<span class="op">,</span> minAge <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> maxAge <span class="op">=</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb4-167"><a href="#cb4-167" tabindex="-1"></a>    </span>
<span id="cb4-168"><a href="#cb4-168" tabindex="-1"></a>    <span class="co">// then write these out:</span></span>
<span id="cb4-169"><a href="#cb4-169" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>s in samps<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-170"><a href="#cb4-170" tabindex="-1"></a>        <span class="va">s_name</span> <span class="op">=</span> paste0<span class="op">(</span>s<span class="op">.</span>sex<span class="op">,</span> sim<span class="op">.</span>generation <span class="op">-</span> s<span class="op">.</span>age<span class="op">,</span> <span class="st">"_0_"</span><span class="op">,</span> s<span class="op">.</span>tag<span class="op">);</span></span>
<span id="cb4-171"><a href="#cb4-171" tabindex="-1"></a>        line <span class="op">=</span> paste<span class="op">(</span><span class="va">s_name</span><span class="op">,</span> <span class="st">""</span><span class="op">,</span> <span class="st">""</span><span class="op">,</span> sim<span class="op">.</span>generation<span class="op">,</span> <span class="st">"0"</span><span class="op">,</span> <span class="st">""</span><span class="op">,</span> <span class="st">""</span><span class="op">,</span> sep <span class="op">=</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb4-172"><a href="#cb4-172" tabindex="-1"></a>        writeFile<span class="op">(</span><span class="st">"spip_samples.tsv"</span><span class="op">,</span> line<span class="op">,</span> append <span class="op">=</span> T<span class="op">);</span></span>
<span id="cb4-173"><a href="#cb4-173" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-174"><a href="#cb4-174" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If you have <code>SLiM</code> on your path, this SLiM simulation
script can be run within R like this (using seed 1001, and also ensuring
that the output files are written to an R temporary directory):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">slim_script</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"SLiM/slim-example-1.slim"</span>, package <span class="op">=</span> <span class="st">"CKMRpop"</span><span class="op">)</span></span>
<span><span class="va">tdir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">tdir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">call</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cd "</span>, <span class="va">tdir</span>, <span class="st">"; "</span>, <span class="st">"SLiM -s 1001 "</span>, <span class="va">slim_script</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="va">call</span><span class="op">)</span></span></code></pre></div>
<p>Once that is complete, the output from the simulation can be slurped
up like this:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">slurped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/slurp_spip.html">slurp_spip</a></span><span class="op">(</span><span class="va">tdir</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>If you do that with SLiM (not done here, because SLiM is not
installed on CRAN’s servers) you can take the resulting
<code>slurped</code> variable and run it through all the other functions
in the <code>species_1_simulation</code> vignette and see how everything
turns out.</p>
<p>For example, if we look at the offspring number of males and females
we see that the way I set this SLiM simulation up there is at most one
offspring per female each year. That’s a little silly, but it was my
first real stab at using SLiM (which, by the way, is completely
<strong>AWESOME</strong>).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">offs_and_mates</span> <span class="op">=</span> <span class="fu"><a href="../reference/summarize_offspring_and_mate_numbers.html">summarize_offspring_and_mate_numbers</a></span><span class="op">(</span></span>
<span>  census_postkill <span class="op">=</span> <span class="va">slurped</span><span class="op">$</span><span class="va">census_postkill</span>,</span>
<span>  pedigree <span class="op">=</span> <span class="va">slurped</span><span class="op">$</span><span class="va">pedigree</span>,</span>
<span>  deaths <span class="op">=</span> <span class="va">slurped</span><span class="op">$</span><span class="va">deaths</span>,</span>
<span>  lifetime_hexbin_width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">num_offs_plot</span> <span class="op">=</span> <span class="va">offs_and_mates</span><span class="op">$</span><span class="va">plot_age_specific_number_of_offspring</span></span>
<span></span>
<span><span class="va">num_offs_plot</span></span></code></pre></div>
<p><img src="../reference/figures/slim1_num_offs_plot.png" width="100%"> At
any rate, this shows the utility of inspecting the outputs of one’s
simulation</p>
</div>
<div class="section level2">
<h2 id="simulating-with-slim-but-recording-ancestral-lineages-internally">Simulating with SLiM, but Recording Ancestral Lineages
Internally<a class="anchor" aria-label="anchor" href="#simulating-with-slim-but-recording-ancestral-lineages-internally"></a>
</h2>
<p>The current version of SLiM provides an option that will store the
IDs of the parents and grandparents of each individual in the
simulation. When these individuals are sampled, that information can be
compiled into an ancestry vector, as used by CKMRpop, and then those
ancestry vectors can be used directly to find related pairs amongst the
sampled individuals. This carries the advantage that it is not necessary
to write out to a file the complete pedigree of the population. This
could potentially save a lot of time when simulating very large
population sizes. Furthermore, although CKMRpop’s kin finding algorithm
(implemented via recursive functions in C++) that operates on the
pedigree is quite fast, as currently implemented, it requires a lot of
time to set up the data structures in large populations. Using SLiM’s
internal pedigree recording could not only avoid that extra time cost,
but it could also minimize or eliminate the need for C++ code within the
CKMRpop package, which would aid usability for people that don’t have a
compiler on their system.</p>
<p>The starting point for this approach is similar to our last example
use of SLiM. We would start with the previous SLiM script and modify it
so as to:</p>
<ol style="list-style-type: decimal">
<li>Not write out the pedigree of every single simulated
individual.</li>
<li>Do write out the ancestry vectors of the sampled individuals.</li>
<li>Provide the <code><a href="../reference/slurp_spip.html">slurp_spip()</a></code> function with a few options
telling it not to bother with getting and processing a pedigree
file.</li>
<li>Directly use the sampled individual’s ancestry vectors from SLiM to
determine who are relatives of one another.</li>
</ol>
<p>After doing this, we won’t have all the information needed to analyze
how many mating partners each individual had (that produced offspring),
etc., but we can compile up the related pairs of individuals.</p>
<p>In the example that follows, I do not execute #1 from the list above,
because I want to compare the pedigree obtatined by recursively
traversing the complete pedigree from sampled individuals to that
obtained by writing out SLiM’s internal pedigree information for only
the sampled individuals. (As we see below, the two approaches yield
identical results, but the latter will be faster—and noticeably so in
large populations, I expect.)</p>
<p>A simple, example SLiM script for doing the simulation whilst
outputting the internal pedigree information for sampled individuals can
be found in the package extras at:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"SLiM/slim-example-2.slim"</span>, package <span class="op">=</span> <span class="st">"CKMRpop"</span><span class="op">)</span></span></code></pre></div>
<p>It looks like this:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>initialize<span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>    initializeSLiMModelType<span class="op">(</span><span class="st">"nonWF"</span><span class="op">);</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>    <span class="co">// This next option provides each individual with a unique, internal, integer ID,</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>    <span class="co">// and also does internal pedigree recording out to grandparents.</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>    initializeSLiMOptions<span class="op">(</span>keepPedigrees <span class="op">=</span> T<span class="op">);</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>    defineConstant<span class="op">(</span><span class="st">"K"</span><span class="op">,</span> <span class="dv">1290</span><span class="op">);</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>    <span class="co">// "species 1" mortality rates for ages 0 to 20.  (All 20-year-olds die)</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>    defineConstant<span class="op">(</span><span class="st">"L"</span><span class="op">,</span> c<span class="op">(</span><span class="fl">0.25</span><span class="op">,</span> <span class="fl">0.24</span><span class="op">,</span> <span class="fl">0.24</span><span class="op">,</span> <span class="fl">0.23</span><span class="op">,</span> <span class="fl">0.23</span><span class="op">,</span> <span class="fl">0.22</span><span class="op">,</span> <span class="fl">0.22</span><span class="op">,</span> <span class="fl">0.21</span><span class="op">,</span> <span class="fl">0.21</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.19</span><span class="op">,</span> <span class="fl">0.19</span><span class="op">,</span> <span class="fl">0.18</span><span class="op">,</span> <span class="fl">0.18</span><span class="op">,</span> <span class="fl">0.18</span><span class="op">,</span> <span class="fl">0.18</span><span class="op">,</span> <span class="fl">0.18</span><span class="op">,</span> <span class="fl">0.18</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">));</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>    initializeMutationType<span class="op">(</span><span class="st">"m1"</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">,</span> <span class="st">"f"</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>    m1<span class="op">.</span>convertToSubstitution <span class="op">=</span> T<span class="op">;</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>    initializeGenomicElementType<span class="op">(</span><span class="st">"g1"</span><span class="op">,</span> m1<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>    initializeGenomicElement<span class="op">(</span>g1<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>    initializeMutationRate<span class="op">(</span><span class="fl">1e-20</span><span class="op">);</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>    initializeRecombinationRate<span class="op">(</span><span class="fl">1e-20</span><span class="op">);</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>    initializeSex<span class="op">(</span><span class="st">"A"</span><span class="op">);</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>    <span class="co">// delete any files that will be appended to and write the headers on them that CKMRpop expects</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"spip_pedigree.tsv"</span><span class="op">,</span> <span class="st">"year</span><span class="sc">\t</span><span class="st">pop</span><span class="sc">\t</span><span class="st">kid</span><span class="sc">\t</span><span class="st">pa</span><span class="sc">\t</span><span class="st">ma"</span><span class="op">);</span></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"spip_prekill_census.tsv"</span><span class="op">,</span> <span class="st">"year</span><span class="sc">\t</span><span class="st">pop</span><span class="sc">\t</span><span class="st">age</span><span class="sc">\t</span><span class="st">male</span><span class="sc">\t</span><span class="st">female"</span><span class="op">);</span></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"spip_postkill_census.tsv"</span><span class="op">,</span> <span class="st">"year</span><span class="sc">\t</span><span class="st">pop</span><span class="sc">\t</span><span class="st">age</span><span class="sc">\t</span><span class="st">male</span><span class="sc">\t</span><span class="st">female"</span><span class="op">);</span></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"spip_samples.tsv"</span><span class="op">,</span> <span class="st">"ID</span><span class="sc">\t</span><span class="st">syears_pre</span><span class="sc">\t</span><span class="st">pop_pre</span><span class="sc">\t</span><span class="st">syears_post</span><span class="sc">\t</span><span class="st">pop_post</span><span class="sc">\t</span><span class="st">syears_dur</span><span class="sc">\t</span><span class="st">pop_dur"</span><span class="op">);</span></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"ancestries.tsv"</span><span class="op">,</span> <span class="st">"ID</span><span class="sc">\t</span><span class="st">ancestors"</span><span class="op">);</span></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>    <span class="co">// these I am just making empty as dummies so that slurp_spip() has an empty</span></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>    <span class="co">// file to read in.</span></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"spip_deaths.tsv"</span><span class="op">,</span> <span class="st">"ID</span><span class="sc">\t</span><span class="st">year</span><span class="sc">\t</span><span class="st">age"</span><span class="op">);</span></span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"spip_genotypes.tsv"</span><span class="op">,</span> <span class="st">"F47_0_136</span><span class="sc">\t</span><span class="st">2/2"</span><span class="op">);</span></span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>    writeFile<span class="op">(</span><span class="st">"spip_migrants.tsv"</span><span class="op">,</span> <span class="st">"year</span><span class="sc">\t</span><span class="st">age</span><span class="sc">\t</span><span class="st">event"</span><span class="op">);</span></span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a></span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a><span class="co">// we don't bother with any age-specific relative fecundities or partial</span></span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a><span class="co">// monogamy in the reproduction here. Rather, we just give males and females</span></span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a><span class="co">// a probability of 1.0 of reproducing if they are above age 6.  It appears that</span></span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a><span class="co">// we just do Poisson number of offspring or something, by default here.  I am</span></span>
<span id="cb9-39"><a href="#cb9-39" tabindex="-1"></a><span class="co">// not going to fuss with overdispersion, though that is clearly possible with SLiM.</span></span>
<span id="cb9-40"><a href="#cb9-40" tabindex="-1"></a>reproduction<span class="op">(</span>NULL<span class="op">,</span> <span class="st">"F"</span><span class="op">)</span> <span class="op">{</span>   <span class="co">// define females as the focal reproducers here</span></span>
<span id="cb9-41"><a href="#cb9-41" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>individual<span class="op">.</span>age <span class="op">&gt;</span> <span class="dv">6</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-43"><a href="#cb9-43" tabindex="-1"></a>        dad <span class="op">=</span> subpop<span class="op">.</span>sampleIndividuals<span class="op">(</span><span class="dv">1</span><span class="op">,</span> sex<span class="op">=</span><span class="st">"M"</span><span class="op">,</span> minAge<span class="op">=</span><span class="dv">7</span><span class="op">);</span></span>
<span id="cb9-44"><a href="#cb9-44" tabindex="-1"></a>        child <span class="op">=</span> subpop<span class="op">.</span>addCrossed<span class="op">(</span>individual<span class="op">,</span> dad<span class="op">);</span></span>
<span id="cb9-45"><a href="#cb9-45" tabindex="-1"></a></span>
<span id="cb9-46"><a href="#cb9-46" tabindex="-1"></a></span>
<span id="cb9-47"><a href="#cb9-47" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" tabindex="-1"></a>        <span class="co">// log the mating in a format that CKMRpop expects.  It isn't entirely equivalent</span></span>
<span id="cb9-49"><a href="#cb9-49" tabindex="-1"></a>        <span class="co">// because the numbers given to males and females in spip are year-specific, but this</span></span>
<span id="cb9-50"><a href="#cb9-50" tabindex="-1"></a>        <span class="co">// should still work.  Note that we are writing these out here to confirm that we</span></span>
<span id="cb9-51"><a href="#cb9-51" tabindex="-1"></a>        <span class="co">// get the same results whether we use the entire output pedigree or just the</span></span>
<span id="cb9-52"><a href="#cb9-52" tabindex="-1"></a>        <span class="co">// internally recorded SLiM pedigre. (In other words, in practice, if using</span></span>
<span id="cb9-53"><a href="#cb9-53" tabindex="-1"></a>        <span class="co">// SLiM's interal pedigreeID recording to get the ancestry vectors of the samples, you typically</span></span>
<span id="cb9-54"><a href="#cb9-54" tabindex="-1"></a>        <span class="co">// would not need to write the entire pedigree out, unless you wanted it to monitor</span></span>
<span id="cb9-55"><a href="#cb9-55" tabindex="-1"></a>        <span class="co">// the number of mates, etc.)</span></span>
<span id="cb9-56"><a href="#cb9-56" tabindex="-1"></a>        child_name <span class="op">=</span> paste0<span class="op">(</span>child<span class="op">.</span>sex<span class="op">,</span> sim<span class="op">.</span>generation<span class="op">,</span> <span class="st">"_0_"</span><span class="op">,</span> child<span class="op">.</span>pedigreeID<span class="op">);</span></span>
<span id="cb9-57"><a href="#cb9-57" tabindex="-1"></a>        dad_name <span class="op">=</span> paste0<span class="op">(</span>dad<span class="op">.</span>sex<span class="op">,</span> sim<span class="op">.</span>generation <span class="op">-</span> dad<span class="op">.</span>age<span class="op">,</span> <span class="st">"_0_"</span><span class="op">,</span> dad<span class="op">.</span>pedigreeID<span class="op">);</span></span>
<span id="cb9-58"><a href="#cb9-58" tabindex="-1"></a>        mom_name <span class="op">=</span> paste0<span class="op">(</span>individual<span class="op">.</span>sex<span class="op">,</span> sim<span class="op">.</span>generation <span class="op">-</span> individual<span class="op">.</span>age<span class="op">,</span> <span class="st">"_0_"</span><span class="op">,</span> individual<span class="op">.</span>pedigreeID<span class="op">);</span></span>
<span id="cb9-59"><a href="#cb9-59" tabindex="-1"></a>        line <span class="op">=</span> paste<span class="op">(</span>c<span class="op">(</span>sim<span class="op">.</span>generation<span class="op">,</span> <span class="st">"0"</span><span class="op">,</span> child_name<span class="op">,</span> dad_name<span class="op">,</span> mom_name<span class="op">),</span> sep <span class="op">=</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb9-60"><a href="#cb9-60" tabindex="-1"></a>        writeFile<span class="op">(</span><span class="st">"spip_pedigree.tsv"</span><span class="op">,</span> line<span class="op">,</span> append<span class="op">=</span>T<span class="op">);</span></span>
<span id="cb9-61"><a href="#cb9-61" tabindex="-1"></a></span>
<span id="cb9-62"><a href="#cb9-62" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-63"><a href="#cb9-63" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-64"><a href="#cb9-64" tabindex="-1"></a></span>
<span id="cb9-65"><a href="#cb9-65" tabindex="-1"></a></span>
<span id="cb9-66"><a href="#cb9-66" tabindex="-1"></a><span class="dv">1</span> early<span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-67"><a href="#cb9-67" tabindex="-1"></a>    sim<span class="op">.</span>addSubpop<span class="op">(</span><span class="st">"p1"</span><span class="op">,</span> K<span class="op">);</span></span>
<span id="cb9-68"><a href="#cb9-68" tabindex="-1"></a>    <span class="co">// Here we initialize the ages to what would be the stationary age distribution</span></span>
<span id="cb9-69"><a href="#cb9-69" tabindex="-1"></a>    <span class="co">// (roughly) given the survival rates.</span></span>
<span id="cb9-70"><a href="#cb9-70" tabindex="-1"></a>    p1<span class="op">.</span>individuals<span class="op">.</span>age <span class="op">=</span> sample<span class="op">(</span>seq<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">20</span><span class="op">),</span> size <span class="op">=</span> K<span class="op">,</span> replace <span class="op">=</span> T<span class="op">,</span> weights <span class="op">=</span> c<span class="op">(</span><span class="dv">150</span><span class="op">,</span> <span class="dv">112</span><span class="op">,</span> <span class="dv">85</span><span class="op">,</span> <span class="dv">64</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">38</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">23</span><span class="op">,</span> <span class="dv">18</span><span class="op">,</span> <span class="dv">14</span><span class="op">,</span> <span class="dv">11</span><span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb9-71"><a href="#cb9-71" tabindex="-1"></a></span>
<span id="cb9-72"><a href="#cb9-72" tabindex="-1"></a></span>
<span id="cb9-73"><a href="#cb9-73" tabindex="-1"></a>    <span class="co">// Now we also have to add each of these starting individuals to</span></span>
<span id="cb9-74"><a href="#cb9-74" tabindex="-1"></a>    <span class="co">// the pedigree as founders.</span></span>
<span id="cb9-75"><a href="#cb9-75" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>i in seqAlong<span class="op">(</span>p1<span class="op">.</span>individuals<span class="op">.</span>pedigreeID<span class="op">))</span> <span class="op">{</span></span>
<span id="cb9-76"><a href="#cb9-76" tabindex="-1"></a>        bornyear <span class="op">=</span> sim<span class="op">.</span>generation <span class="op">-</span> p1<span class="op">.</span>individuals<span class="op">.</span>age<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb9-77"><a href="#cb9-77" tabindex="-1"></a>        iname <span class="op">=</span> p1<span class="op">.</span>individuals<span class="op">.</span>sex<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> bornyear <span class="op">+</span> <span class="st">"_0_"</span> <span class="op">+</span> p1<span class="op">.</span>individuals<span class="op">.</span>pedigreeID<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb9-78"><a href="#cb9-78" tabindex="-1"></a>        iage <span class="op">=</span> p1<span class="op">.</span>individuals<span class="op">.</span>age<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb9-79"><a href="#cb9-79" tabindex="-1"></a>        line <span class="op">=</span> paste<span class="op">(</span><span class="st">"0"</span><span class="op">,</span> <span class="st">"0"</span><span class="op">,</span> iname<span class="op">,</span> <span class="st">"0"</span><span class="op">,</span> <span class="st">"0"</span><span class="op">,</span> sep <span class="op">=</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb9-80"><a href="#cb9-80" tabindex="-1"></a>        writeFile<span class="op">(</span><span class="st">"spip_pedigree.tsv"</span><span class="op">,</span> line<span class="op">,</span> append<span class="op">=</span>T<span class="op">);</span></span>
<span id="cb9-81"><a href="#cb9-81" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-82"><a href="#cb9-82" tabindex="-1"></a></span>
<span id="cb9-83"><a href="#cb9-83" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-84"><a href="#cb9-84" tabindex="-1"></a></span>
<span id="cb9-85"><a href="#cb9-85" tabindex="-1"></a></span>
<span id="cb9-86"><a href="#cb9-86" tabindex="-1"></a>early<span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-87"><a href="#cb9-87" tabindex="-1"></a>    <span class="co">// count up the number of individuals of different ages and sexes</span></span>
<span id="cb9-88"><a href="#cb9-88" tabindex="-1"></a>    inds <span class="op">=</span> p1<span class="op">.</span>individuals<span class="op">;</span></span>
<span id="cb9-89"><a href="#cb9-89" tabindex="-1"></a>    ages <span class="op">=</span> inds<span class="op">.</span>age<span class="op">;</span></span>
<span id="cb9-90"><a href="#cb9-90" tabindex="-1"></a>    age_bins <span class="op">=</span> <span class="dv">0</span><span class="op">:</span><span class="dv">20</span><span class="op">;</span>  <span class="co">// age categories, 0 to 20</span></span>
<span id="cb9-91"><a href="#cb9-91" tabindex="-1"></a>    male_ages <span class="op">=</span> ages<span class="op">[</span>inds<span class="op">.</span>sex <span class="op">==</span> <span class="st">"M"</span><span class="op">];</span></span>
<span id="cb9-92"><a href="#cb9-92" tabindex="-1"></a>    female_ages <span class="op">=</span> ages<span class="op">[</span>inds<span class="op">.</span>sex <span class="op">==</span> <span class="st">"F"</span><span class="op">];</span></span>
<span id="cb9-93"><a href="#cb9-93" tabindex="-1"></a>    <span class="va">m_census</span> <span class="op">=</span> tabulate<span class="op">(</span>male_ages<span class="op">,</span> maxbin <span class="op">=</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb9-94"><a href="#cb9-94" tabindex="-1"></a>    f_census <span class="op">=</span> tabulate<span class="op">(</span>female_ages<span class="op">,</span> maxbin <span class="op">=</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb9-95"><a href="#cb9-95" tabindex="-1"></a></span>
<span id="cb9-96"><a href="#cb9-96" tabindex="-1"></a>    <span class="co">// write those numbers out to the prekill census file</span></span>
<span id="cb9-97"><a href="#cb9-97" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>a in age_bins<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-98"><a href="#cb9-98" tabindex="-1"></a>        line <span class="op">=</span> paste<span class="op">(</span>sim<span class="op">.</span>generation<span class="op">,</span> <span class="st">"0"</span><span class="op">,</span> a<span class="op">,</span> <span class="va">m_census</span><span class="op">[</span>a<span class="op">],</span> f_census<span class="op">[</span>a<span class="op">],</span> sep <span class="op">=</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb9-99"><a href="#cb9-99" tabindex="-1"></a>        writeFile<span class="op">(</span><span class="st">"spip_prekill_census.tsv"</span><span class="op">,</span> line<span class="op">,</span> append<span class="op">=</span>T<span class="op">);</span></span>
<span id="cb9-100"><a href="#cb9-100" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-101"><a href="#cb9-101" tabindex="-1"></a></span>
<span id="cb9-102"><a href="#cb9-102" tabindex="-1"></a></span>
<span id="cb9-103"><a href="#cb9-103" tabindex="-1"></a></span>
<span id="cb9-104"><a href="#cb9-104" tabindex="-1"></a>    <span class="co">// life table based individual mortality</span></span>
<span id="cb9-105"><a href="#cb9-105" tabindex="-1"></a>    mortality <span class="op">=</span> L<span class="op">[</span>ages<span class="op">];</span></span>
<span id="cb9-106"><a href="#cb9-106" tabindex="-1"></a>    survival <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> mortality<span class="op">;</span></span>
<span id="cb9-107"><a href="#cb9-107" tabindex="-1"></a>    inds<span class="op">.</span>fitnessScaling <span class="op">=</span> survival<span class="op">;</span></span>
<span id="cb9-108"><a href="#cb9-108" tabindex="-1"></a>    <span class="co">// density-dependence, factoring in individual mortality</span></span>
<span id="cb9-109"><a href="#cb9-109" tabindex="-1"></a>    p1<span class="op">.</span>fitnessScaling <span class="op">=</span> K <span class="op">/</span> <span class="op">(</span>p1<span class="op">.</span>individualCount <span class="op">*</span> mean<span class="op">(</span>survival<span class="op">));</span></span>
<span id="cb9-110"><a href="#cb9-110" tabindex="-1"></a></span>
<span id="cb9-111"><a href="#cb9-111" tabindex="-1"></a>    <span class="co">// remember the extant individual tags, and what their names are.</span></span>
<span id="cb9-112"><a href="#cb9-112" tabindex="-1"></a>    <span class="co">// This is a bunch of rigamoral so that we can know the IDs of the</span></span>
<span id="cb9-113"><a href="#cb9-113" tabindex="-1"></a>    <span class="co">// individuals that die in the next generation</span></span>
<span id="cb9-114"><a href="#cb9-114" tabindex="-1"></a>    sim<span class="op">.</span>setValue<span class="op">(</span><span class="st">"extant_tags"</span><span class="op">,</span> sim<span class="op">.</span>subpopulations<span class="op">.</span>individuals<span class="op">.</span>pedigreeID<span class="op">);</span></span>
<span id="cb9-115"><a href="#cb9-115" tabindex="-1"></a>    e_sex <span class="op">=</span> sim<span class="op">.</span>subpopulations<span class="op">.</span>individuals<span class="op">.</span>sex<span class="op">;</span></span>
<span id="cb9-116"><a href="#cb9-116" tabindex="-1"></a>    e_born <span class="op">=</span> sim<span class="op">.</span>generation <span class="op">-</span> sim<span class="op">.</span>subpopulations<span class="op">.</span>individuals<span class="op">.</span>age<span class="op">;</span></span>
<span id="cb9-117"><a href="#cb9-117" tabindex="-1"></a>    e_age <span class="op">=</span> sim<span class="op">.</span>subpopulations<span class="op">.</span>individuals<span class="op">.</span>age<span class="op">;</span></span>
<span id="cb9-118"><a href="#cb9-118" tabindex="-1"></a>    e_tags <span class="op">=</span> sim<span class="op">.</span>subpopulations<span class="op">.</span>individuals<span class="op">.</span>pedigreeID<span class="op">;</span></span>
<span id="cb9-119"><a href="#cb9-119" tabindex="-1"></a>    e_lines <span class="op">=</span> e_sex<span class="op">;</span></span>
<span id="cb9-120"><a href="#cb9-120" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>i in seqAlong<span class="op">(</span>e_sex<span class="op">))</span> <span class="op">{</span></span>
<span id="cb9-121"><a href="#cb9-121" tabindex="-1"></a>        e_lines<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> e_sex<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> e_born<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span>  <span class="st">"_0_"</span> <span class="op">+</span> e_tags<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span> <span class="op">+</span> sim<span class="op">.</span>generation <span class="op">+</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span> <span class="op">+</span> e_age<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb9-122"><a href="#cb9-122" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-123"><a href="#cb9-123" tabindex="-1"></a>    sim<span class="op">.</span>setValue<span class="op">(</span><span class="st">"extant_lines"</span><span class="op">,</span> e_lines<span class="op">);</span></span>
<span id="cb9-124"><a href="#cb9-124" tabindex="-1"></a></span>
<span id="cb9-125"><a href="#cb9-125" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-126"><a href="#cb9-126" tabindex="-1"></a></span>
<span id="cb9-127"><a href="#cb9-127" tabindex="-1"></a></span>
<span id="cb9-128"><a href="#cb9-128" tabindex="-1"></a>late<span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-129"><a href="#cb9-129" tabindex="-1"></a>    <span class="co">// count up the number of individuals of different ages and sexes</span></span>
<span id="cb9-130"><a href="#cb9-130" tabindex="-1"></a>    inds <span class="op">=</span> p1<span class="op">.</span>individuals<span class="op">;</span></span>
<span id="cb9-131"><a href="#cb9-131" tabindex="-1"></a>    ages <span class="op">=</span> inds<span class="op">.</span>age<span class="op">;</span></span>
<span id="cb9-132"><a href="#cb9-132" tabindex="-1"></a>    age_bins <span class="op">=</span> <span class="dv">0</span><span class="op">:</span><span class="dv">20</span><span class="op">;</span>  <span class="co">// age categories, 0 to 20</span></span>
<span id="cb9-133"><a href="#cb9-133" tabindex="-1"></a>    male_ages <span class="op">=</span> ages<span class="op">[</span>inds<span class="op">.</span>sex <span class="op">==</span> <span class="st">"M"</span><span class="op">];</span></span>
<span id="cb9-134"><a href="#cb9-134" tabindex="-1"></a>    female_ages <span class="op">=</span> ages<span class="op">[</span>inds<span class="op">.</span>sex <span class="op">==</span> <span class="st">"F"</span><span class="op">];</span></span>
<span id="cb9-135"><a href="#cb9-135" tabindex="-1"></a>    <span class="va">m_census</span> <span class="op">=</span> tabulate<span class="op">(</span>male_ages<span class="op">,</span> maxbin <span class="op">=</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb9-136"><a href="#cb9-136" tabindex="-1"></a>    f_census <span class="op">=</span> tabulate<span class="op">(</span>female_ages<span class="op">,</span> maxbin <span class="op">=</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb9-137"><a href="#cb9-137" tabindex="-1"></a></span>
<span id="cb9-138"><a href="#cb9-138" tabindex="-1"></a>    <span class="co">// write those numbers out to the prekill census file</span></span>
<span id="cb9-139"><a href="#cb9-139" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>a in age_bins<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-140"><a href="#cb9-140" tabindex="-1"></a>        line <span class="op">=</span> paste<span class="op">(</span>sim<span class="op">.</span>generation<span class="op">,</span> <span class="st">"0"</span><span class="op">,</span> a<span class="op">,</span> <span class="va">m_census</span><span class="op">[</span>a<span class="op">],</span> f_census<span class="op">[</span>a<span class="op">],</span> sep <span class="op">=</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb9-141"><a href="#cb9-141" tabindex="-1"></a>        writeFile<span class="op">(</span><span class="st">"spip_postkill_census.tsv"</span><span class="op">,</span> line<span class="op">,</span> append<span class="op">=</span>T<span class="op">);</span></span>
<span id="cb9-142"><a href="#cb9-142" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-143"><a href="#cb9-143" tabindex="-1"></a></span>
<span id="cb9-144"><a href="#cb9-144" tabindex="-1"></a>    <span class="co">// report the individuals that died</span></span>
<span id="cb9-145"><a href="#cb9-145" tabindex="-1"></a>    oldExtant <span class="op">=</span> sim<span class="op">.</span>getValue<span class="op">(</span><span class="st">"extant_tags"</span><span class="op">);</span></span>
<span id="cb9-146"><a href="#cb9-146" tabindex="-1"></a>    newExtant <span class="op">=</span> sim<span class="op">.</span>subpopulations<span class="op">.</span>individuals<span class="op">.</span>pedigreeID<span class="op">;</span></span>
<span id="cb9-147"><a href="#cb9-147" tabindex="-1"></a>    old_lines <span class="op">=</span> sim<span class="op">.</span>getValue<span class="op">(</span><span class="st">"extant_lines"</span><span class="op">);</span></span>
<span id="cb9-148"><a href="#cb9-148" tabindex="-1"></a>    survived <span class="op">=</span> <span class="op">(</span>match<span class="op">(</span>oldExtant<span class="op">,</span> newExtant<span class="op">)</span> <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb9-149"><a href="#cb9-149" tabindex="-1"></a>    died_lines <span class="op">=</span> old_lines<span class="op">[!</span>survived<span class="op">];</span></span>
<span id="cb9-150"><a href="#cb9-150" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>line in died_lines<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-151"><a href="#cb9-151" tabindex="-1"></a>        writeFile<span class="op">(</span><span class="st">"spip_deaths.tsv"</span><span class="op">,</span> line<span class="op">,</span> append<span class="op">=</span>T<span class="op">);</span></span>
<span id="cb9-152"><a href="#cb9-152" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-153"><a href="#cb9-153" tabindex="-1"></a></span>
<span id="cb9-154"><a href="#cb9-154" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-155"><a href="#cb9-155" tabindex="-1"></a></span>
<span id="cb9-156"><a href="#cb9-156" tabindex="-1"></a></span>
<span id="cb9-157"><a href="#cb9-157" tabindex="-1"></a><span class="co">// sample 3% of the 1, 2, and 3-year olds during years 50 to 75, inclusive</span></span>
<span id="cb9-158"><a href="#cb9-158" tabindex="-1"></a><span class="dv">50</span><span class="op">:</span><span class="dv">75</span> late<span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-159"><a href="#cb9-159" tabindex="-1"></a>    <span class="co">// get the total number of indivdiuals of age 1 to 3</span></span>
<span id="cb9-160"><a href="#cb9-160" tabindex="-1"></a>    num_1_to_3 <span class="op">=</span> sum<span class="op">(</span>tabulate<span class="op">(</span>p1<span class="op">.</span>individuals<span class="op">.</span>age<span class="op">,</span> maxbin <span class="op">=</span> <span class="dv">20</span><span class="op">)[</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span><span class="op">]);</span></span>
<span id="cb9-161"><a href="#cb9-161" tabindex="-1"></a></span>
<span id="cb9-162"><a href="#cb9-162" tabindex="-1"></a>    <span class="co">// get the total number to sample</span></span>
<span id="cb9-163"><a href="#cb9-163" tabindex="-1"></a>    ns <span class="op">=</span> rbinom<span class="op">(</span><span class="dv">1</span><span class="op">,</span> num_1_to_3<span class="op">,</span> <span class="fl">0.03</span><span class="op">);</span></span>
<span id="cb9-164"><a href="#cb9-164" tabindex="-1"></a></span>
<span id="cb9-165"><a href="#cb9-165" tabindex="-1"></a>    <span class="co">// then sample them:</span></span>
<span id="cb9-166"><a href="#cb9-166" tabindex="-1"></a>    samps <span class="op">=</span> p1<span class="op">.</span>sampleIndividuals<span class="op">(</span>ns<span class="op">,</span> minAge <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> maxAge <span class="op">=</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb9-167"><a href="#cb9-167" tabindex="-1"></a></span>
<span id="cb9-168"><a href="#cb9-168" tabindex="-1"></a>    <span class="co">// then write these out to the samples file, and also write out</span></span>
<span id="cb9-169"><a href="#cb9-169" tabindex="-1"></a>    <span class="co">// their ancestry vectors to a file called ancestries.tsv</span></span>
<span id="cb9-170"><a href="#cb9-170" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>s in samps<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-171"><a href="#cb9-171" tabindex="-1"></a>        <span class="va">s_name</span> <span class="op">=</span> paste0<span class="op">(</span>s<span class="op">.</span>sex<span class="op">,</span> sim<span class="op">.</span>generation <span class="op">-</span> s<span class="op">.</span>age<span class="op">,</span> <span class="st">"_0_"</span><span class="op">,</span> s<span class="op">.</span>pedigreeID<span class="op">);</span></span>
<span id="cb9-172"><a href="#cb9-172" tabindex="-1"></a>        line <span class="op">=</span> paste<span class="op">(</span><span class="va">s_name</span><span class="op">,</span> <span class="st">""</span><span class="op">,</span> <span class="st">""</span><span class="op">,</span> sim<span class="op">.</span>generation<span class="op">,</span> <span class="st">"0"</span><span class="op">,</span> <span class="st">""</span><span class="op">,</span> <span class="st">""</span><span class="op">,</span> sep <span class="op">=</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb9-173"><a href="#cb9-173" tabindex="-1"></a>        writeFile<span class="op">(</span><span class="st">"spip_samples.tsv"</span><span class="op">,</span> line<span class="op">,</span> append <span class="op">=</span> T<span class="op">);</span></span>
<span id="cb9-174"><a href="#cb9-174" tabindex="-1"></a></span>
<span id="cb9-175"><a href="#cb9-175" tabindex="-1"></a>        <span class="co">// the SLiM manual is not exact about the ordering of the parents and grandparents</span></span>
<span id="cb9-176"><a href="#cb9-176" tabindex="-1"></a>        <span class="co">// in the pedigeeParentIDs and pedigreeGrandparentIDs, but I will assume that it</span></span>
<span id="cb9-177"><a href="#cb9-177" tabindex="-1"></a>        <span class="co">// it ordered consistently with sex, and will hope that it at least somewhat</span></span>
<span id="cb9-178"><a href="#cb9-178" tabindex="-1"></a>        <span class="co">// matches the ordering of an ancestry vector as defined within CKMRpop.</span></span>
<span id="cb9-179"><a href="#cb9-179" tabindex="-1"></a>        <span class="co">// We will write the ancestry vector out separated by commas:</span></span>
<span id="cb9-180"><a href="#cb9-180" tabindex="-1"></a>        <span class="va">s_anc</span> <span class="op">=</span> c<span class="op">(</span>s<span class="op">.</span>pedigreeID<span class="op">,</span> s<span class="op">.</span>pedigreeParentIDs<span class="op">,</span> s<span class="op">.</span>pedigreeGrandparentIDs<span class="op">);</span></span>
<span id="cb9-181"><a href="#cb9-181" tabindex="-1"></a></span>
<span id="cb9-182"><a href="#cb9-182" tabindex="-1"></a>        <span class="co">// SLiM records maternal lineages before paternal lineages, so these need to</span></span>
<span id="cb9-183"><a href="#cb9-183" tabindex="-1"></a>        <span class="co">// be reordered to match up with CKMRpop's ordering of ancestry vectors.</span></span>
<span id="cb9-184"><a href="#cb9-184" tabindex="-1"></a>        <span class="va">s_anc</span> <span class="op">=</span> <span class="va">s_anc</span><span class="op">[</span>c<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">3</span><span class="op">)];</span></span>
<span id="cb9-185"><a href="#cb9-185" tabindex="-1"></a>        <span class="va">s_anc_commas</span> <span class="op">=</span> paste<span class="op">(</span><span class="va">s_anc</span><span class="op">,</span> sep <span class="op">=</span> <span class="st">","</span><span class="op">);</span></span>
<span id="cb9-186"><a href="#cb9-186" tabindex="-1"></a>        line <span class="op">=</span> paste<span class="op">(</span>s<span class="op">.</span>pedigreeID<span class="op">,</span> <span class="va">s_anc_commas</span><span class="op">,</span> sep <span class="op">=</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb9-187"><a href="#cb9-187" tabindex="-1"></a>        writeFile<span class="op">(</span><span class="st">"ancestries.tsv"</span><span class="op">,</span> line<span class="op">,</span> append <span class="op">=</span> T<span class="op">);</span></span>
<span id="cb9-188"><a href="#cb9-188" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-189"><a href="#cb9-189" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We can run that from within R like this:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">slim_script</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"SLiM/slim-example-2.slim"</span>, package <span class="op">=</span> <span class="st">"CKMRpop"</span><span class="op">)</span></span>
<span><span class="va">tdir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">tdir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">call</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cd "</span>, <span class="va">tdir</span>, <span class="st">"; "</span>, <span class="st">"SLiM -s 1001 "</span>, <span class="va">slim_script</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="va">call</span><span class="op">)</span></span></code></pre></div>
<p>And then we can gather all that information into CKMRpop:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First we do it while not reading the</span></span>
<span><span class="co"># complete population pedigree but reading in the ancestries,  like this:</span></span>
<span><span class="va">s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/slurp_spip.html">slurp_spip</a></span><span class="op">(</span></span>
<span>  <span class="va">tdir</span>, </span>
<span>  <span class="fl">2</span>, </span>
<span>  read_pedigree_file <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>  find_ancestors_and_relatives <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get the ancestries</span></span>
<span><span class="va">anc</span> <span class="op">&lt;-</span> <span class="fu">read_tsv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tdir</span>, <span class="st">"ancestries.tsv"</span><span class="op">)</span>, col_types <span class="op">=</span> <span class="st">"ic"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ancestors <span class="op">=</span> <span class="fu">str_split</span><span class="op">(</span><span class="va">ancestors</span>, <span class="st">","</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Note, the last filter above is important: if some individuals were sampled</span></span>
<span><span class="co"># multiple times in their lifetime, we still only want them to appear once here.</span></span>
<span></span>
<span></span>
<span><span class="co"># find the relatives from those ancestry vectors</span></span>
<span><span class="va">anc_rel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/relatives_from_ancestry_vectors.html">relatives_from_ancestry_vectors</a></span><span class="op">(</span><span class="va">anc</span><span class="op">)</span></span></code></pre></div>
<p>At this juncture, we have to rename the individuals in the
<code>relatives</code> column of the tibble <code>anc_rel</code> so as
to use their “full” names that start with F or M and have the year they
were born. These are all samples, so we actually have all their names,
and the pedIDs are unique so it is not too hard to get that taken care
of:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">full_names</span> <span class="op">&lt;-</span> <span class="va">s2</span><span class="op">$</span><span class="va">samples</span><span class="op">$</span><span class="va">ID</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">full_names</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">str_match</span><span class="op">(</span><span class="va">full_names</span>, <span class="st">"_([0-9]+)$"</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">anc_rel2</span> <span class="op">&lt;-</span> <span class="va">anc_rel</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    relatives <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>      .x <span class="op">=</span> <span class="va">relatives</span>,</span>
<span>      .f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">full_names</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>With that done, we now simply join these with the samples and then
run <code><a href="../reference/compile_related_pairs.html">compile_related_pairs()</a></code> on the result:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">SAMPLES</span> <span class="op">&lt;-</span> <span class="va">s2</span><span class="op">$</span><span class="va">samples</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pedID <span class="op">=</span> <span class="fu">str_match</span><span class="op">(</span><span class="va">full_names</span>, <span class="st">"_([0-9]+)$"</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">anc_rel2</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pedID"</span> <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">crel_from_pedIDs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compile_related_pairs.html">compile_related_pairs</a></span><span class="op">(</span><span class="va">SAMPLES</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="compare-with-pairs-obtained-from-the-entire-output-pedigree">Compare with pairs obtained from the entire output pedigree<a class="anchor" aria-label="anchor" href="#compare-with-pairs-obtained-from-the-entire-output-pedigree"></a>
</h3>
<p>It is worth confirming that the approach in which the ancestry of
each sampled individual is recorded using SLiM’s pedigreeID
functionality yields the same results that we obtain when printing out
the whole pedigree. Let’s confirm that.</p>
<p>First we need to read the output files including the full
pedigree.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Second, we read the complete pedigree in and look at</span></span>
<span><span class="co"># the ancestry vectors obtained from that method.</span></span>
<span><span class="va">s2_old</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/slurp_spip.html">slurp_spip</a></span><span class="op">(</span></span>
<span>  <span class="va">tdir</span>, </span>
<span>  <span class="fl">2</span>, </span>
<span>  read_pedigree_file <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>  find_ancestors_and_relatives <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">crel_from_full_pedigree</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compile_related_pairs.html">compile_related_pairs</a></span><span class="op">(</span><span class="va">s2_old</span><span class="op">$</span><span class="va">samples</span><span class="op">)</span></span></code></pre></div>
<p>Now we simply need to compare those two results:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">methods_joined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span></span>
<span>  <span class="va">crel_from_full_pedigree</span>,</span>
<span>  <span class="va">crel_from_pedIDs</span>, </span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id_1"</span>, <span class="st">"id_2"</span><span class="op">)</span>,</span>
<span>  suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"_full"</span>, <span class="st">"pedID"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># and check that the inferred pairwise relationships</span></span>
<span><span class="co"># between all pairs are the same, regardless of the method</span></span>
<span><span class="co"># adopted.</span></span>
<span><span class="va">methods_joined</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>comp_dom_relat <span class="op">=</span> <span class="op">(</span><span class="va">dom_relat_full</span> <span class="op">==</span> <span class="va">dom_relatpedID</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">comp_dom_relat</span><span class="op">)</span></span></code></pre></div>
<p>The above block is not evaluated, because SLiM cannot be installed on
CRAN’s servers that run checks on packages, but the both methods yielded
the same results.</p>
</div>
</div>
<div class="section level2">
<h2 id="some-notes">Some notes<a class="anchor" aria-label="anchor" href="#some-notes"></a>
</h2>
<p>This is how I determined that SLiM puts its ancestry vectors in a
slightly different order (moms before dads), and hence permuted their
order within the slim script (see the line that looks like):</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>        <span class="va">s_anc</span> <span class="op">=</span> <span class="va">s_anc</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">6</span>, <span class="fl">5</span>, <span class="fl">4</span>, <span class="fl">3</span><span class="op">)</span><span class="op">]</span>; </span></code></pre></div>
<p>We can compare the ancestry vectors from SLiM to those found by
traversing the output pedigree with CKMRpop and see how SLiM orders
individuals in its pedigreeParentIDs and pedigreeGrandparentIDs.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rename the columns in anc</span></span>
<span><span class="va">anc2</span> <span class="op">&lt;-</span> <span class="va">anc</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>    pedID <span class="op">=</span> <span class="va">ID</span>,</span>
<span>    anc_vec <span class="op">=</span> <span class="va">ancestors</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># first, get the ancestries from each approach together in the same tibble</span></span>
<span><span class="va">av_comp</span> <span class="op">&lt;-</span> <span class="va">s2_old</span><span class="op">$</span><span class="va">samples</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">ancestors</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    pedID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu">str_extract</span><span class="op">(</span><span class="va">ID</span>, <span class="st">"([0-9]+)$"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    CKMRpop_anc_vec <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">ancestors</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">str_extract</span><span class="op">(</span><span class="va">x</span>, <span class="st">"([0-9]+)$"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ancestors</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">anc2</span>, by <span class="op">=</span> <span class="st">"pedID"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>slim_anc_vec <span class="op">=</span> <span class="va">anc_vec</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># now we can see where each element of the CKMRpop ancestry vector</span></span>
<span><span class="co"># maps into the ancestry vector obtained using SLiM's pedigreeIDs</span></span>
<span><span class="va">perms</span> <span class="op">&lt;-</span> <span class="va">av_comp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>positions <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="va">CKMRpop_anc_vec</span>,</span>
<span>    .y <span class="op">=</span> <span class="va">slim_anc_vec</span>,</span>
<span>    .f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">positions</span><span class="op">)</span></span>
<span></span>
<span><span class="va">perms</span><span class="op">$</span><span class="va">positions</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-haller2019slim" class="csl-entry">
Haller, Benjamin C, and Philipp W Messer. 2019. <span>“SLiM 3: Forward
Genetic Simulations Beyond the Wright–Fisher Model.”</span>
<em>Molecular Biology and Evolution</em> 36 (3): 632–37.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Eric C. Anderson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
